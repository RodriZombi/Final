<!DOCTYPE html>
<html>
<head>
  <title>Juego de Rompecabezas</title>
  <style>
    canvas {
      border: 1px solid #000;
    }
    body {
      background: linear-gradient(105deg, #b6dae8, #d0bbec, #b1e0bd, #d8cfa9);
      padding: 20px;
    }
  </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
</head>
<body>
    <section class="hero is-fullheight">
        <div class="hero-body">
          <div class="container has-text-centered">
            <p class="title">Juego Final: Rompecabezas.</p>
            <p class="subtitle">Arrastra las piezas del rompecabezas a los bordes del lado correcto...</p>
  <canvas id="puzzleCanvas" width="800" height="800" class="is-centered"></canvas>
          </div>
        </div>
    </section>

  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
    crossorigin="anonymous"></script>
  <script>
    const canvas = document.getElementById('puzzleCanvas');
    const context = canvas.getContext('2d');
    const imagePath = 'gisirodri.jpg';
    const pieces = 9;

    const pieceSize = 800 / Math.sqrt(pieces);
    const image = new Image();

    let puzzlePieces = [];

    image.onload = function () {
      sliceImage();
      shufflePieces();
      drawPuzzle();
    };

    image.src = imagePath;

    function sliceImage() {
      for (let i = 0; i < pieces; i++) {
        const row = Math.floor(i / Math.sqrt(pieces));
        const col = i % Math.sqrt(pieces);

        const piece = {
          index: i,
          x: col * pieceSize,
          y: row * pieceSize,
          correctX: col * pieceSize,
          correctY: row * pieceSize
        };

        puzzlePieces.push(piece);
      }
    }

    function shufflePieces() {
      for (let i = puzzlePieces.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [puzzlePieces[i].x, puzzlePieces[j].x] = [puzzlePieces[j].x, puzzlePieces[i].x];
        [puzzlePieces[i].y, puzzlePieces[j].y] = [puzzlePieces[j].y, puzzlePieces[i].y];
      }
    }

    function drawPuzzle() {
      context.clearRect(0, 0, canvas.width, canvas.height);

      for (let i = 0; i < pieces; i++) {
        const piece = puzzlePieces[i];

        context.drawImage(
          image,
          piece.correctX,
          piece.correctY,
          pieceSize,
          pieceSize,
          piece.x,
          piece.y,
          pieceSize,
          pieceSize
        );

        context.strokeRect(piece.x, piece.y, pieceSize, pieceSize);
      }
    }

    canvas.addEventListener('mousedown', function (event) {
      const rect = canvas.getBoundingClientRect();
      const mouseX = event.clientX - rect.left;
      const mouseY = event.clientY - rect.top;

      let selectedPiece = null;
      for (let i = 0; i < pieces; i++) {
        const piece = puzzlePieces[i];

        if (
          mouseX >= piece.x &&
          mouseX <= piece.x + pieceSize &&
          mouseY >= piece.y &&
          mouseY <= piece.y + pieceSize
        ) {
          selectedPiece = piece;
          break;
        }
      }

      if (selectedPiece) {
        canvas.addEventListener('mousemove', dragPiece);
        canvas.addEventListener('mouseup', releasePiece);

        let offsetX = mouseX - selectedPiece.x;
        let offsetY = mouseY - selectedPiece.y;

        function dragPiece(event) {
          const newMouseX = event.clientX - rect.left;
          const newMouseY = event.clientY - rect.top;

          selectedPiece.x = newMouseX - offsetX;
          selectedPiece.y = newMouseY - offsetY;

          drawPuzzle();
        }

        function releasePiece() {
          canvas.removeEventListener('mousemove', dragPiece);
          canvas.removeEventListener('mouseup', releasePiece);

          selectedPiece.x = Math.floor(selectedPiece.x / pieceSize) * pieceSize;
          selectedPiece.y = Math.floor(selectedPiece.y / pieceSize) * pieceSize;

          drawPuzzle();

          if (checkPuzzleCompletion()) {
            redirectToNextPage();
          }
        }
      }
    });

    function checkPuzzleCompletion() {
      for (let i = 0; i < pieces; i++) {
        const piece = puzzlePieces[i];

        if (piece.x !== piece.correctX || piece.y !== piece.correctY) {
          return false;
        }
      }

      return true;
    }

    function redirectToNextPage() {
      window.location.href = 'final.html';
    }
  </script>
</body>
</html>
